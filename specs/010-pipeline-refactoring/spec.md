# Feature Specification: パイプライン・リファクタリング

**Feature Branch**: `010-pipeline-refactoring`
**Created**: 2026-02-17
**Status**: Draft
**Input**: Issue#12 - リファクタリング: pipeline.pyを個別スクリプトに分解し、命名統一とフォルダ整理を行う

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 個別スクリプトの独立実行 (Priority: P1)

開発者として、動画からXMLを生成するワークフローの各ステップを個別のスクリプトとして独立実行できるようにしたい。これにより、特定のステップのみを再実行したり、デバッグしやすくなる。

**Why this priority**: パイプライン分解はリファクタリングの核心であり、他の改善（命名統一、フォルダ整理）の前提条件となる。

**Independent Test**: 各スクリプトを単独でCLIから実行し、期待される中間出力が生成されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 入力動画ファイルが存在する, **When** フレーム抽出スクリプトを実行する, **Then** 指定フォルダに画像フレームが出力される
2. **Given** 抽出されたフレーム画像がある, **When** レイアウト解析スクリプトを実行する, **Then** レイアウト情報ファイルが生成される
3. **Given** レイアウト情報がある, **When** OCRスクリプトを実行する, **Then** テキスト抽出結果が生成される
4. **Given** OCR結果がある, **When** 統合スクリプトを実行する, **Then** 最終XMLが出力される

---

### User Story 2 - 命名規則の統一 (Priority: P2)

開発者として、モジュール名とコマンド名が統一された命名規則に従うようにしたい。「yomitoku-ocr」「rover-ocr」などの固有名称を「rover」に統一し、コードベースの一貫性を高める。

**Why this priority**: 命名の一貫性は保守性を高め、新しい開発者の学習コストを下げる。P1のスクリプト分解後に実施する。

**Independent Test**: リネーム後の全スクリプトとモジュールが動作し、テストがパスすることを確認できる。

**Acceptance Scenarios**:

1. **Given** 現在のコードベースがある, **When** 命名規則を統一する, **Then** 全てのモジュールと関数名が新しい命名規則に従う
2. **Given** リネーム後のコードがある, **When** 既存のテストを実行する, **Then** 全てのテストがパスする

---

### User Story 3 - フォルダ構造の整理 (Priority: P2)

開発者として、スクリプト単位でフォルダを分割し、各機能の責務が明確になるようにしたい。

**Why this priority**: コードの見通しを良くし、保守性を向上させる。命名統一と同時に進めることができる。

**Independent Test**: 新しいフォルダ構造で全てのimportが正しく解決され、テストがパスすることを確認できる。

**Acceptance Scenarios**:

1. **Given** 現在のフラットなsrc構造がある, **When** フォルダを再構成する, **Then** 各機能が独自のサブフォルダに配置される
2. **Given** 再構成後のコードがある, **When** importを修正して実行する, **Then** 全ての機能が正常に動作する

---

### User Story 4 - 後方互換性コードの除去 (Priority: P2)

開発者として、不要になったフォールバック処理や後方互換性のためのコードを除去し、コードベースを簡素化したい。

**Why this priority**: 技術的負債を減らし、コードの理解を容易にする。リファクタリング作業中に同時に実施可能。

**Independent Test**: フォールバックコード除去後も全機能が動作し、テストがパスすることを確認できる。

**Acceptance Scenarios**:

1. **Given** フォールバック処理を含むコードがある, **When** 不要なフォールバックを除去する, **Then** コードが簡素化され、テストがパスする
2. **Given** 後方互換性コードが除去されている, **When** 機能を実行する, **Then** 新しいパスのみが使用される

---

### User Story 5 - ワークフロー手順書の作成 (Priority: P3)

開発者として、動画からXMLまでの完全なワークフロー手順書を参照できるようにしたい。途中でMarkdownにマーカーを追加する手動ステップも明記する。

**Why this priority**: ドキュメントは機能実装後に作成可能であり、コードの安定性が優先される。

**Independent Test**: 手順書に従って新しい動画を処理し、最終XMLが生成されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 手順書が存在する, **When** 手順通りに作業を実行する, **Then** 動画からXMLが正常に生成される
2. **Given** 手順書が存在する, **When** マーカー追加が必要な段階に達する, **Then** 手順書に明確な指示がある

---

### Edge Cases

- 中間ファイルが存在しない状態で後続スクリプトを実行した場合は何が起きるか？ → 明確なエラーメッセージを表示
- 部分的にフォルダ移動が完了した状態でのimportエラーはどう対処するか？ → 移行は原子的に行い、中間状態を避ける

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは `pipeline.py` の各処理ステップを独立したCLIスクリプトとして提供しなければならない
- **FR-002**: 各スクリプトはCLI引数で入力ファイル/フォルダと出力先を指定できなければならない
- **FR-003**: システムは「yomitoku-ocr」「rover-ocr」などの名称を「rover」に統一しなければならない
- **FR-004**: システムは機能単位でフォルダを分割し、各フォルダに関連ファイルをまとめなければならない
- **FR-005**: システムは後方互換性のためのフォールバック処理を全て除去しなければならない
- **FR-006**: システムは動画からXMLまでのワークフロー手順書を提供しなければならない
- **FR-007**: 手順書にはMarkdownへのマーカー追加など手動ステップを明記しなければならない
- **FR-008**: 各独立スクリプトは実行に必要な入力が存在しない場合、明確なエラーメッセージを出力しなければならない

### Key Entities

- **スクリプト**: ワークフローの各ステップを実行する独立したCLIコマンド
- **中間ファイル**: スクリプト間で受け渡されるデータ（フレーム画像、レイアウトJSON、OCRテキスト等）
- **設定ファイル**: 各スクリプトの動作を制御するパラメータ
- **手順書**: ワークフロー全体を説明するドキュメント

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: `pipeline.py` が独立した5つ以上のスクリプトに分解される
- **SC-002**: 全てのモジュール名から「yomitoku」「rover-ocr」などの固有名称が除去され、統一された命名規則に従う
- **SC-003**: src直下のファイル数が減少し、機能別サブフォルダに整理される
- **SC-004**: 後方互換性のためのフォールバックコードが0件になる
- **SC-005**: ワークフロー手順書を読んで、新規開発者が30分以内に動画からXMLを生成できる
- **SC-006**: 既存の全テストがパスする

## Clarifications

### Session 2026-02-17

- Q: ruff導入とファイル分割のスコープ → A: 別Issue（011）で対応。010では対象外。

## Assumptions

- 後方互換性は不要と明言されているため、既存の外部システムとの互換性は考慮しない
- ワークフローは開発者向けであり、エンドユーザー向けのUIは不要

## Out of Scope

以下は別Issue（011-lint-file-split）で対応:
- ruff導入とpre-commit hook設定
- 600行超ファイルの分割
