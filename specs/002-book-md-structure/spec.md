# Feature Specification: Book Markdown Standardization

**Feature Branch**: `002-book-md-structure`
**Created**: 2026-02-07
**Status**: Clarified
**Input**: User description: "book.mdを構造化したい。いまは統一性のない書き方になっている。ページは目印があるが、ページの番号なども情報の一部として掲載されている感じ。タイトルなどを「#」で強調するのはよいが、イマイチわかりにくい。Ebookでのページの書式を参考にしてマークダウンでページ情報を表現する方法を模索したい"

## Clarifications

### Session 2026-02-07

- Q: 図の説明文はTTSで読み上げますか？ → A: ユーザーが選択できるようにする（読み上げる/しないを制御可能）
- Q: ページ番号や「1 / 1」などのメタデータはどう扱いますか？ → A: ページ変わり目で「1ページ」と読み上げる
- Q: XMLとMarkdownのどちらを採用しますか？ → A: XML形式を採用（TTS制御が明確、SSML変換容易）
- Q: 変換処理の自動化レベルは？ → A: 半自動変換（Pythonスクリプトで基本構造を変換、複雑な部分は人手で調整）。取得できなかった項目は空属性やブランク要素で残す（例：`<page number="">`）
- Q: 見出し階層の最大深度は？ → A: 3階層まで（level="1"=章, level="2"=節, level="3"=小節）
- Q: 「3 / 7」表記の意味は？ → A: 章内のページ番号として扱う（現在の書籍では「第3章の7ページ目」の意味）。ただし、`<pageMetadata type="chapter-page">3 / 7</pageMetadata>`のようにtype属性で意味を明示し、将来的に異なる意味（section-page, unknownなど）にも対応可能にする
- Q: XML変換スクリプトのエラーハンドリングは？ → A: 警告を出力して継続。エラー箇所は空要素やXMLコメントでマークし、変換を続行。最後に警告ログをまとめて表示する

## User Scenarios & Testing *(mandatory)*

### User Story 1 - TTS Page Navigation and Audio Announcement (Priority: P1)

利用者は、TTSで書籍を聴く際、ページが切り替わるタイミングでページ番号が音声アナウンスされ、元の紙の本のページ番号と対応付けて理解できる必要がある。また、特定のページから読み上げを開始したい場合、XMLファイル内で該当ページを素早く特定できる必要がある。

**Why this priority**: TTS利用者にとってページ番号の音声アナウンスは、紙の本との対応や聴取位置の把握に不可欠。すべての機能の基盤となる。

**Independent Test**: 任意のページ番号（例：42ページ）を指定し、XMLファイル内でXPathクエリ`//page[@number='42']`により該当箇所を10秒以内に見つけ、TTSで「42ページ」と読み上げられることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 利用者が「42ページから聴きたい」と思ったとき、**When** XMLファイルでページ42を検索（`<page number="42">`）、**Then** 該当ページが一意に特定でき、TTSが「42ページ」とアナウンスして読み上げ開始
2. **Given** 元の書籍の目次から「第3章 3.2節」を探す場合、**When** XML内で章節見出しを検索（`<heading level="2">3.2節</heading>`）、**Then** 該当箇所が一意に特定できる
3. **Given** TTSでページをまたぐ長文を聴いているとき、**When** ページ境界に到達、**Then** TTSが「Nページ」とアナウンスし、次のページへの継続が音声で明確に示される

---

### User Story 2 - TTS Content Hierarchy and Structure Parsing (Priority: P2)

利用者およびTTSシステムは、書籍の章立て構造（章、節、小節）をXML階層から正確に抽出し、TTSで読み上げる際に適切な音声の抑揚やポーズを制御できる必要がある。XML構造が明確でなければ、見出しレベルに応じた読み上げ制御ができない。

**Why this priority**: 構造理解はTTSの音声品質と学習効率に直結するが、ページアナウンスができなければ意味がないため、P1の次の優先度。

**Independent Test**: XML内の任意の位置（例：ページ50）を開き、XPathクエリで親階層を辿り、「今どの章のどの節に属しているか」を3秒以内に判断できることでテスト可能。

**Acceptance Scenarios**:

1. **Given** TTSが書籍の中間部分（ページ50）を読み上げているとき、**When** XMLを解析して現在位置の親要素を確認、**Then** 章番号、章タイトル、節番号、節タイトルが`<heading level="1|2">`要素から正確に抽出できる
2. **Given** 複数階層の見出しが連続する場合（章→節→小節）、**When** XMLを解析、**Then** 各`<heading level="N">`要素の階層レベルが明確に区別できる（level属性で1, 2, 3を識別）
3. **Given** 図表やリストを含むセクション、**When** XML構造を解析、**Then** それらが所属する章節（親`<heading>`要素）が明確に把握できる

---

### User Story 3 - TTS Figure Description Control and Metadata Separation (Priority: P3)

利用者は、TTSで書籍を聴く際、図表の説明を読み上げるか省略するかを選択できる必要がある。また、ページ番号やファイル名などのメタデータが本文読み上げに混入せず、音声の流れが自然である必要がある。

**Why this priority**: 図表の読み上げ制御は重要だが、ページアナウンスと構造解析ができていれば、省略しても書籍の理解は可能。利用者の好みに依存する機能。

**Independent Test**: ページ内の図を含むXMLをTTSで読み上げ、`readAloud`属性に応じて図の説明が読まれる/省略されることを確認できることでテスト可能。

**Acceptance Scenarios**:

1. **Given** ページに図表が含まれ`<figure readAloud="optional">`とマークされているとき、**When** TTSで読み上げ、**Then** 利用者の設定に応じて図の`<description>`が読まれる、または省略される
2. **Given** ページ末尾のページ番号表記（例："3 / 7"）が`<pageMetadata>`要素に格納されているとき、**When** TTSで読み上げ、**Then** この表記は本文として読み上げられず、メタデータとして無視される
3. **Given** 図のファイル名が`<file>`要素に格納されているとき、**When** TTSで読み上げ、**Then** ファイル名（例："page_0001_figure1.png"）は読み上げられず、音声の流れが自然に保たれる

---

### Edge Cases

- **ページ番号が欠落している場合**: 一部ページに番号がない場合、`<page number="">`として空属性にし、前後のページから推測可能な注釈をXMLコメントで追加する
- **ページをまたぐ段落や図表**: ページ境界が段落や図表の途中にある場合、`<page continued="true">`属性を付与し、TTSが「続く」とアナウンスする
- **複数のページ番号表記形式**: 元の書籍に「3 / 7」「ページ42」など複数の形式がある場合、`<pageMetadata type="chapter-page">3 / 7</pageMetadata>`のように元の表記を保存し、`<page number="42">`属性は統一形式に正規化する。TTSで読み上げる際、`type="chapter-page"`なら「第3章 7ページ目」、`type="unknown"`なら読み上げをスキップする
- **目次専用ページ**: 目次だけのページは`<toc>`要素として構造化し、TTSで読み上げる際は「目次」とアナウンスする
- **表紙、奥付などの特殊ページ**: 通常の本文ページとは異なる`<page type="cover|colophon">`属性を付与し、TTSで適切にアナウンスする
- **図が複数ページにまたがる場合**: `<figure continued="true">`属性を付与し、次ページの図要素と関連付ける
- **読み上げ不可能な記号や数式**: `<math>`要素でマークし、TTSが「数式」とアナウンスするか、MathML変換を行う
- **変換時に情報が取得できない場合**: Pythonスクリプトが自動抽出できなかった項目（ページ番号、見出しレベルなど）は、空属性（`number=""`）やブランク要素（`<caption></caption>`）として残し、人手で後から補完できるようにする
- **Markdownの不規則な形式**: 元のbook.mdが不規則な形式（見出しマーカーの不統一、ページマーカーの欠落など）の場合、スクリプトはベストエフォートで変換し、警告ログを出力する
- **4階層以上の深いネスト**: 元のMarkdownに`####`（4階層）以上の見出しがある場合、Pythonスクリプトは警告を出し、`level="3"`（小節）に統合する、または人手での調整が必要な箇所としてマークする
- **変換エラーの記録形式**: スクリプトがエラーに遭遇した場合、XMLコメント`<!-- ERROR: [エラー種別] - [詳細] -->`として該当箇所にマークし、最後に警告サマリーを標準エラー出力に表示する。エラー箇所数が全体の10%を超える場合は、変換完了後に明示的な警告メッセージを表示する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、各ページをXML要素`<page>`で表現し、属性`number`（ページ番号）と`sourceFile`（画像ファイル名）を含めなければならない
- **FR-002**: システムは、ページ番号やファイル名などのメタデータをXML属性として本文コンテンツから分離しなければならない
- **FR-003**: システムは、章、節、小節の階層構造をXML要素`<heading level="1|2|3">`で一貫して表現しなければならない。`level`属性は1（章）、2（節）、3（小節）の3階層までサポートし、4以上の値は許可しない
- **FR-004**: システムは、図表をXML要素`<figure>`で表現し、`<file>`, `<caption>`, `<description>`子要素を含めなければならない
- **FR-005**: システムは、TTS読み上げ制御のためのXML属性（`readAloud="true|false|optional"`）を提供しなければならない
- **FR-006**: システムは、元のページ画像ファイル名を`<page sourceFile="...">`属性として必ず含めなければならない
- **FR-007**: システムは、ページをまたぐコンテンツに対して継続を示す属性（`continued="true"`）を提供しなければならない
- **FR-008**: システムは、目次ページを構造化されたXML要素`<toc>`と`<tocItem>`のリストとして表現しなければならない
- **FR-009**: システムは、TTS標準（SSML, DAISY）およびEbook標準（EPUB）で使用される慣例的なXML構造を参考にして設計しなければならない
- **FR-010**: システムは、既存のbook.md（Markdown形式）を新しいXML標準形式に半自動変換するPythonスクリプトを提供しなければならない。スクリプトは基本構造（ページ、見出し、図表）を自動抽出し、取得できなかった項目は空属性（例：`<page number="">`）やブランク要素として残さなければならない。エラー発生時は処理を中断せず、エラー箇所を空要素やXMLコメント（`<!-- ERROR: 理由 -->`）でマークして変換を続行し、最後に警告ログをまとめて表示しなければならない
- **FR-011**: システムは、ページ変わり目でページ番号を読み上げるための制御要素（`<pageAnnouncement>`）を提供しなければならない
- **FR-012**: システムは、図の説明文の読み上げをユーザーが制御可能にするため、`<figure readAloud="optional">`属性をサポートしなければならない
- **FR-013**: システムは、「3 / 7」のようなページ内メタデータを`<pageMetadata type="chapter-page|section-page|unknown">`要素で表現しなければならない。`type`属性で意味を明示し（デフォルト: "chapter-page"）、将来的に異なる書籍フォーマットにも対応可能とする

### Key Entities

- **Page**: 1つの物理的なページを表すXML要素`<page>`。属性：`number`（ページ番号）、`sourceFile`（画像ファイル名）、`continued`（継続フラグ）。子要素：`<content>`, `<figure>`, `<pageMetadata>`, `<pageAnnouncement>`
- **Heading**: 章、節、小節などの見出しを表すXML要素`<heading>`。属性：`level`（1=章, 2=節, 3=小節の3階層まで、4以上は不可）。内容：見出しテキスト
- **Figure**: 図表を表すXML要素`<figure>`。属性：`readAloud`（optional/true/false）。子要素：`<file>`（図ファイルパス）、`<caption>`（図のタイトル）、`<description>`（説明文）
- **Content**: ページの本文を表すXML要素`<content>`。属性：`readAloud`（デフォルトtrue）。内容：段落、見出し、リストなどの本文要素
- **PageAnnouncement**: ページ読み上げ用のXML要素`<pageAnnouncement>`。属性：`format`（読み上げ形式）。内容：「1ページ」などの読み上げテキスト
- **PageMetadata**: ページ内メタデータを表すXML要素`<pageMetadata>`。属性：`type`（"chapter-page"=章内ページ番号、"section-page"=セクション内ページ番号、"unknown"=意味不明）。内容：「3 / 7」のような元の表記。TTSで読み上げる際、typeに応じて「第3章 7ページ目」のように自然に変換される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが任意のページ番号を指定したとき、XML内で該当ページ要素（`<page number="X">`）を10秒以内にXPathクエリで特定できる
- **SC-002**: XMLをパースしたとき、章節構造（`<heading level="1|2|3">`）が階層的に明確に区別できる（3段階以上の階層を正確に抽出可能）
- **SC-003**: TTSで読み上げたとき、ページ番号やファイル名などのメタデータが本文読み上げに混入せず、`<pageMetadata type="chapter-page">3 / 7</pageMetadata>`は「第3章 7ページ目」のように自然に変換され、利用者の90%が「音声の流れが自然」と感じる
- **SC-004**: 既存のbook.md（Markdown、100ページ以上）を新しいXML標準形式に変換する際、95%以上のページが正しく構造化される
- **SC-005**: XML形式のbook.xmlをTTSで読み上げる際、ページ切り替わり時に「Nページ」が自動アナウンスされ、図の説明読み上げをユーザーが制御できる
- **SC-006**: 標準化されたXML形式への変換後、SSML（音声合成マークアップ言語）やEPUB形式への二次変換が追加作業なしで可能となる

## Assumptions

- 元の書籍は紙の本であり、各ページに対応する画像ファイル（`page_XXXX.png`形式）が存在する
- 一部のページには「3 / 7」のような部分ページ番号表記が含まれるが、これは`<pageMetadata>`要素として扱う
- 利用者の主目的はTTS（Text-to-Speech）での読み上げであり、人間が直接XMLを読むことは想定しない
- TTS engineはXML要素と属性を解釈し、`readAloud`属性に基づいて読み上げ制御が可能である
- XML形式への変換後、SSML（Speech Synthesis Markup Language）やDAISY（Digital Accessible Information System）形式への変換が想定される
- 図表は別ファイルとして保存されており、XMLから`<file>`要素で参照可能である
- XMLパーサー（DOM/SAX）が利用可能で、XPathクエリによる要素検索がサポートされる

## Out of Scope

- 自動的なOCR補正やテキスト品質向上（既にOCR済みのテキストを前提とする）
- TTS engine本体の実装（既存のTTS engineを使用することを前提とする）
- SSML/DAISY/EPUB形式への実際の変換処理（XML構造を定義するのみ）
- インタラクティブな音声ナビゲーション機能（XMLファイル形式の定義のみ）
- 複数の書籍を統合管理する仕組み（1冊のbook.xmlを対象とする）
- 画像ファイルの最適化やサムネイル生成（既存の図ファイルを前提とする）
- TTSの音声品質調整（速度、音程、ポーズなど）は利用者のTTS engine設定に依存
