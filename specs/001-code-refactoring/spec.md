# Feature Specification: コードベースリファクタリング

**Feature Branch**: `001-code-refactoring`
**Created**: 2026-02-04
**Status**: Draft
**Input**: User description: "リファクタリング。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 共有ユーティリティの抽出によるモジュール結合度の解消 (Priority: P1)

開発者として、モジュール間の不要な結合（`ocr_deepseek.py` → `ocr.py`）を解消し、重複コード（`_encode_image()`、`_mask_figure_regions()`）を共有ユーティリティに統合したい。これにより、各モジュールを独立して変更・テストできるようにする。

**Why this priority**: モジュール結合がリファクタリングの最大障害。`ocr_deepseek.py` が使われていない `ocr.py` に依存しており、デッドコード削除やモジュール独立テストを妨げている。この結合を解消しなければ後続の改善が全て困難になる。

**Independent Test**: 共有ユーティリティ抽出後、パイプライン全体を実行し、出力結果が変更前と同一であることを確認できる。各モジュールが独立してインポート可能であることも検証可能。

**Acceptance Scenarios**:

1. **Given** 現行パイプラインの出力結果をベースラインとして保存している状態, **When** 共有ユーティリティを抽出してインポートを修正した後にパイプラインを実行する, **Then** 出力が既存ベースラインと完全一致する
2. **Given** リファクタリング済みのコードベース, **When** `ocr_deepseek.py` を単独でインポートする, **Then** `ocr.py` への依存なしにインポートが成功する
3. **Given** リファクタリング済みのコードベース, **When** 重複していた関数（`_encode_image`、`_mask_figure_regions`）を検索する, **Then** 各関数の実装が1箇所のみに存在する

---

### User Story 2 - デッドコードとレガシー依存の除去 (Priority: P2)

開発者として、使われていないレガシーモジュール（`ocr.py`）と不要な依存パッケージ（easyocr、pytesseract、opencv-python）を除去したい。コードベースのサイズと認知的負荷を削減し、保守性を向上させる。

**Why this priority**: P1で結合が解消されれば、レガシーコードを安全に除去できる。219行のデッドコードと3つの不要依存を削除することで、コードベースの理解とメンテナンスが容易になる。

**Independent Test**: レガシーモジュールと不要依存を削除した後、パイプラインを実行してベースラインと同一の結果が得られることを確認できる。

**Acceptance Scenarios**:

1. **Given** P1完了後のコードベース, **When** `ocr.py` を削除しパイプラインを実行する, **Then** 出力がベースラインと一致し、エラーが発生しない
2. **Given** リファクタリング済みのコードベース, **When** 依存パッケージ一覧を確認する, **Then** easyocr、pytesseract、opencv-python が含まれていない
3. **Given** リファクタリング済みのコードベース, **When** コードベース全体を検索する, **Then** 未使用のインポート文やモジュール参照が存在しない

---

### User Story 3 - 自動テストスイートの導入 (Priority: P3)

開発者として、主要なユーティリティ関数とパイプラインステップに対する自動テストを導入したい。今後のリファクタリングや機能追加時にリグレッションを検出できるようにする。

**Why this priority**: P1とP2でコード構造が改善された後、テストを追加することで品質を継続的に担保できる。現在テストカバレッジが0%であり、既存のtest/ディレクトリのデータを活用できる。

**Independent Test**: テストスイートを実行して全テストが成功すること、テスト対象の関数が意図通りに動作することを確認できる。

**Acceptance Scenarios**:

1. **Given** テストスイートが存在する状態, **When** テスト実行コマンドを実行する, **Then** 全テストが成功する
2. **Given** 共有ユーティリティ関数に対するテスト, **When** 関数に正常な入力を与える, **Then** 期待される出力が返される
3. **Given** パイプラインの各ステップに対する統合テスト, **When** テスト用サンプルデータで実行する, **Then** 各ステップが正しく動作する

---

### Edge Cases

- 共有ユーティリティ抽出時に、`ocr.py` と `ocr_deepseek.py` で `_mask_figure_regions()` の実装が異なる場合、どちらの挙動を正とするか
- レガシーモジュール削除後に、他のスクリプトやノートブックから `ocr.py` を参照している箇所がないか
- テスト用サンプルデータが特定の動画にのみ対応しており、一般的なテストケースとして不十分な場合

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 重複している関数（`_encode_image()`、`_format_figure_markers()`、`_mask_figure_regions()`）を単一の共有モジュールに統合しなければならない
- **FR-002**: `ocr_deepseek.py` から `ocr.py` への依存を完全に除去しなければならない
- **FR-003**: レガシーOCRモジュール（`ocr.py`）を削除しなければならない
- **FR-004**: 使用されていない依存パッケージ（easyocr、pytesseract、opencv-python）を `requirements.txt` から除去しなければならない
- **FR-005**: リファクタリング後のパイプライン出力が、リファクタリング前の出力と同一でなければならない（回帰なし）
- **FR-006**: 共有ユーティリティ関数に対する単体テストが存在しなければならない
- **FR-007**: パイプラインの主要ステップに対する統合テストが存在しなければならない
- **FR-008**: リソース管理パターン（画像ファイルのコンテキストマネージャ使用）を適用しなければならない

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: コードベース内に重複する関数実装が存在しない（各共有関数の定義が1箇所のみ）
- **SC-002**: パイプラインの全ステップがリファクタリング前と同一の出力を生成する
- **SC-003**: レガシーモジュール除去により、コードベースの総行数が15%以上削減される
- **SC-004**: 自動テストスイートが存在し、全テストが成功する
- **SC-005**: 各ソースモジュールが他のモジュールのプライベート関数（`_` prefix）に依存しない
- **SC-006**: `requirements.txt` に未使用の依存パッケージが含まれない

## Assumptions

- 現在アクティブなパイプラインパス（v3: `ocr_deepseek.py` ベース）のみを保持対象とする
- `ocr.py` と `ocr_deepseek.py` の `_mask_figure_regions()` が異なる実装の場合、`ocr_deepseek.py` の実装（アクティブパス）を正とする
- テストは既存の `test/` ディレクトリのサンプルデータを活用する
- 外部API（Ollama、FFmpeg）を呼び出すテストはモック化する
- パイプラインの機能追加や動作変更は本リファクタリングのスコープ外とする
