# 機能仕様書: TOC解析改行結合とページ欠損修正

**機能ブランチ**: `006-fix-toc-line-merge`
**作成日**: 2026-02-09
**ステータス**: Draft
**入力**: Issue#6 TOC解析改行分割エントリ結合 + コンバーター欠損率改善

## Clarifications

### Session 2026-02-09

- Q: ページ欠損エラーの検出閾値は？ → A: 50%以上欠損でエラー

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - TOC改行分割エントリの結合 (優先度: P1)

ユーザーがPDFから変換されたマークダウンファイルを処理する際、TOCセクション内で改行によって分割されたエントリ（例: 「Chapter」と「1 「企画」で失敗」が別々の行）が、正しく1つのエントリとして結合される。

**優先度の理由**: TOCが正しく構造化されないと、後続のページグルーピング処理でページが正しくchapterに割り当てられず、大量のページが欠損する原因となるため。

**独立テスト**: 改行で分割されたTOCを含むマークダウンを入力し、生成されたXMLのTOCエントリが正しく結合されていることを確認できる。

**受け入れシナリオ**:

1. **Given** TOCセクション内に「Chapter」と次行に「1 「企画」で失敗」がある, **When** パーサーがTOCを解析する, **Then** `<entry level="chapter" number="1" title="「企画」で失敗" />` が生成される
2. **Given** TOCセクション内に「Episode 01」と次行に「なんでもできる「全部入りソフトウェア」」がある, **When** パーサーがTOCを解析する, **Then** `<entry level="other" title="Episode 01 なんでもできる「全部入りソフトウェア」" />` が生成される
3. **Given** TOCセクション内に「Column」と次行に「何を、なぜ作るのかが最重要」がある, **When** パーサーがTOCを解析する, **Then** `<entry level="other" title="Column 何を、なぜ作るのかが最重要" />` が生成される

---

### ユーザーストーリー 2 - ページ欠損の防止 (優先度: P1)

ユーザーが書籍全体を変換する際、TOC構造が不完全でもすべてのページがXML出力に含まれる。TOCにマッチしないページはfront-matterまたは適切なデフォルトセクションに配置される。

**優先度の理由**: 181ページ中10ページしか出力されない現状は致命的な欠損であり、機能として成立していないため。

**独立テスト**: 181ページのマークダウンを入力し、出力XMLに181ページすべてが含まれていることを確認できる。

**受け入れシナリオ**:

1. **Given** 181ページを含むマークダウンファイル, **When** コンバーターで変換する, **Then** 出力XMLに181個の`<page>`要素が存在する
2. **Given** TOCにマッチしないページがある, **When** コンバーターで変換する, **Then** そのページはfront-matterまたは最初のchapterに配置される
3. **Given** TOCが空または解析不能, **When** コンバーターで変換する, **Then** すべてのページがfront-matterに配置され、欠損しない
4. **Given** TOCが存在し181ページの入力がある, **When** 変換後の出力が90ページ未満（50%未満）, **Then** エラーメッセージが出力される

---

### ユーザーストーリー 3 - 既存動作の保持 (優先度: P1)

既に正しく変換されているファイル（例: `4fd5500620491ebe`）の出力結果が変更されない。

**優先度の理由**: 既存の正常動作を壊すと、以前処理したファイルとの互換性が失われるため。

**独立テスト**: 正常に変換済みのマークダウンを再度変換し、TOC構造とページ数が同一であることを確認できる。

**受け入れシナリオ**:

1. **Given** 正しく構造化されたTOC（1行形式）を持つマークダウン, **When** パーサーがTOCを解析する, **Then** 以前と同一のTOC構造が生成される
2. **Given** `4fd5500620491ebe/book.md`, **When** コンバーターで変換する, **Then** 出力XMLのTOCエントリ数とページ数が変化しない

---

### エッジケース

- 「Chapter」だけの行の後に空行が続く場合、次の非空行と結合する
- 「Episode」の後に番号がない場合（例: 「Episode」だけ）は結合しない
- TOCマーカー（`<!-- toc -->`）が複数ページにまたがる場合も正しく処理する
- 「**Episode 24**」のようにマークダウン強調記号で囲まれている場合も認識する
- 出力ページ数が入力の50%未満の場合、エラーメッセージを出力する（処理は継続し、ユーザーが結果を確認可能）

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、TOCセクション内の「Chapter」単独行とその次の行「N タイトル」を結合して「Chapter N タイトル」として解析しなければならない
- **FR-002**: システムは、TOCセクション内の「Episode NN」行とその次の行「タイトル」を結合して「Episode NN タイトル」として解析しなければならない
- **FR-003**: システムは、TOCセクション内の「Column」単独行とその次の行「タイトル」を結合して「Column タイトル」として解析しなければならない
- **FR-004**: システムは、「Chapter N タイトル」形式をlevel="chapter"、number="N"として認識しなければならない
- **FR-005**: システムは、TOCにマッチしないページをfront-matterまたは最初のchapterに配置し、欠損させてはならない
- **FR-006**: システムは、既に1行形式で正しく構造化されたTOC（例: 「第1章 SREとは」）の解析結果を変更してはならない
- **FR-007**: システムは、マークダウン強調記号（`**`）で囲まれたTOCエントリ（例: `**Episode 24**`）を正しく認識しなければならない
- **FR-008**: システムは、TOCが存在するにもかかわらず出力ページ数が入力ページ数の50%未満の場合、エラーを報告しなければならない

### 主要エンティティ

- **TOCEntry**: TOCの1エントリを表す。level（chapter/section/subsection/other）、number（章番号）、title（タイトル）を持つ
- **Page**: 書籍の1ページを表す。ページ番号、ソースファイル、コンテンツ、メタデータを持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 問題のあるファイル（157012a97dcbebed）のTOCが正しく結合され、「Chapter」「Episode」「Column」が単独エントリとして存在しない
- **SC-002**: 問題のあるファイル（157012a97dcbebed）の出力XMLに181ページすべてが含まれる（現状10ページ → 181ページ）
- **SC-003**: 正常なファイル（4fd5500620491ebe）の出力XMLが変更されない（回帰なし）
- **SC-004**: 新規追加されたパターン（Chapter N形式、Episode NN形式、Column形式）に対するテストがすべて成功する
- **SC-005**: 50%以上のページ欠損が発生した場合、エラーメッセージが出力される

## 前提条件

- 結合対象のキーワード（Chapter、Episode、Column）は日本語書籍のTOCで一般的に使用されるパターンに基づく
- 「Episode」の後には常に2桁の番号（01-99）が続くと仮定
- 空行は結合の区切りとして扱わず、次の非空行と結合する
- TOC外の本文には影響を与えない
