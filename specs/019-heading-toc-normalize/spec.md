# Feature Specification: book.md の見出し形式統一と TOC マッチング改善

**Feature Branch**: `019-heading-toc-normalize`
**Created**: 2026-02-27
**Status**: Draft
**Input**: User description: "Issue#31 - book.md の見出し形式統一と TOC マッチング改善"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 見出しパターンの自動抽出 (Priority: P1)

ユーザーは大量のページを持つ `book.md` ファイルから、見出しパターンを自動的に抽出したい。手動で全ファイルを読む代わりに、システムがMarkdown見出し（`##`）を抽出し、パターンを分析することで、統一すべき形式を素早く特定できる。

**Why this priority**: 見出しパターンの把握が正規化の前提条件。数万行のファイルを手動で確認するのは非効率であり、この機能がなければ後続の正規化が不可能。

**Independent Test**: book.md から見出し行を抽出し、頻度の高いパターン（番号あり/なし、フォーマット差異等）をレポートとして出力できる。

**Acceptance Scenarios**:

1. **Given** 数千行以上の book.md が存在する, **When** 見出し抽出を実行する, **Then** `## ` で始まる全行がリストアップされる
2. **Given** 見出し抽出結果がある, **When** パターン分析を実行する, **Then** 「番号付き見出し」「番号なし見出し」「Markdownマーカーなし」の3カテゴリに分類される
3. **Given** パターン分析結果がある, **When** 頻度レポートを生成する, **Then** 各パターンの出現回数と代表例が表示される

---

### User Story 2 - TOC形式への見出し正規化 (Priority: P1)

ユーザーは、本文の見出しをTOC（目次）の形式に合わせて一括正規化したい。TOCが「1.1 SREの概要」形式を使用している場合、本文の「## SREの概要」も「## 1.1 SREの概要」に変換される。これにより、book.xml変換時にTOCエントリと本文見出しが正しくマッチングする。

**Why this priority**: TOCと本文見出しの一致がbook.xml生成の核心機能。マッチングが失敗すると、目次リンクが機能せず、読み上げの章構造が破綻する。

**Independent Test**: TOC内の番号付きエントリと、本文の番号なし見出しを照合し、番号を自動付与して正規化後のbook.mdを出力できる。

**Acceptance Scenarios**:

1. **Given** TOCに「1.1 SREの概要」がある, **When** 本文に「## SREの概要」がある, **Then** 「## 1.1 SREの概要」に正規化される
2. **Given** TOCに「1.1.1 サイトとは何か」がある, **When** 本文に「サイトとは何か」（マーカーなし）がある, **Then** 「### 1.1.1 サイトとは何か」に正規化される
3. **Given** 本文に「## 1.1 SREの概要」（既に番号付き）がある, **When** 正規化を実行する, **Then** 変更なし（二重番号付与しない）
4. **Given** TOCに存在しない見出しがある, **When** 正規化を実行する, **Then** 警告を出力し、手動確認を促す

---

### User Story 3 - 正規化スクリプトの生成 (Priority: P2)

ユーザーは、正規化ルールを再利用可能なスクリプト（sed/awk等）として出力したい。同じ書籍形式の複数ファイルに対して、同じ正規化ルールを適用できる。

**Why this priority**: 一度分析した書籍形式は、シリーズ本や同じ出版社の書籍で再利用可能。手動での正規化作業を自動化し、作業時間を大幅に短縮できる。

**Independent Test**: パターン分析結果から sed/awk コマンドを生成し、別のbook.mdに適用して同じ正規化が実行できる。

**Acceptance Scenarios**:

1. **Given** TOCパターン分析結果がある, **When** スクリプト生成を実行する, **Then** 実行可能なシェルスクリプトが出力される
2. **Given** 生成されたスクリプトがある, **When** 別のbook.mdに適用する, **Then** 同じ正規化ルールが適用される
3. **Given** スクリプトを実行した, **When** 変換前後の差分を確認する, **Then** 意図した変更のみが適用されている

---

### User Story 4 - 正規化結果の検証 (Priority: P2)

ユーザーは、正規化後のbook.mdをbook.xmlに変換し、TOCエントリと本文見出しが正しくマッチングしていることを検証したい。

**Why this priority**: 正規化の最終目的はXML変換の品質向上。検証なしでは正規化の効果を確認できない。

**Independent Test**: 正規化後のbook.mdからbook.xmlを生成し、`<tableOfContents>` のエントリ数と本文の`<heading>`要素数を比較できる。

**Acceptance Scenarios**:

1. **Given** 正規化済みbook.mdがある, **When** book.xmlに変換する, **Then** TOCエントリと本文見出しが1:1でマッチする
2. **Given** book.xmlが生成された, **When** 検証レポートを出力する, **Then** マッチング率、未マッチエントリの一覧が表示される
3. **Given** 未マッチエントリがある, **When** 詳細を確認する, **Then** TOCエントリ内容と最も類似した本文見出しが提示される

---

### Edge Cases

- 同名の見出しが複数存在する場合 → ページ番号や出現順序で区別
- TOCに「はじめに」「おわりに」等の番号なしエントリがある場合 → そのまま保持（番号付与しない）
- 見出しテキストにOCR誤認識がある場合 → ファジーマッチング（類似度80%以上）で対応
- TOC内のページ番号と本文のページマーカーが一致しない場合 → 警告を出力
- 見出し階層がTOCと本文で異なる場合（TOCは3階層、本文は2階層等） → 警告を出力し、手動確認を促す

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは book.md から `##` で始まる見出し行を抽出できなければならない
- **FR-002**: システムは `<!-- toc -->` ... `<!-- /toc -->` 内のエントリを解析できなければならない
- **FR-003**: システムは TOCエントリの番号パターン（N.N, N.N.N等）を認識できなければならない
- **FR-004**: システムは本文見出しとTOCエントリをテキスト照合（完全一致またはファジーマッチ）できなければならない
- **FR-005**: システムは照合結果に基づき、本文見出しに番号を付与できなければならない
- **FR-006**: システムは Markdownマーカーなしのテキストに `##` または `###` を付与できなければならない
- **FR-007**: システムは正規化ルールを sed/awk スクリプトとして出力できなければならない
- **FR-008**: システムは正規化前後の差分をプレビューできなければならない
- **FR-009**: システムは正規化結果のTOC-本文マッチング率を検証できなければならない
- **FR-010**: システムは未マッチエントリを警告として出力しなければならない

### Key Entities

- **TocEntry**: TOC内の1エントリ。番号（N.N形式）、タイトル、ページ番号を持つ
- **BodyHeading**: 本文内の見出し。Markdownレベル（##, ###）、番号（あれば）、タイトルを持つ
- **NormalizationRule**: 正規化ルール。元パターン、変換後パターン、適用条件を持つ
- **MatchResult**: TOCエントリと本文見出しのマッチング結果。マッチ状態、類似度スコアを持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 見出し抽出が1万行以上のbook.mdで10秒以内に完了する
- **SC-002**: TOC-本文マッチング率が正規化前と比較して30%以上向上する
- **SC-003**: 正規化後のbook.xml変換で、TOCエントリの95%以上が本文見出しとマッチする
- **SC-004**: 生成されたスクリプトが同一形式の書籍に対して再利用可能である
- **SC-005**: ファジーマッチングにより、OCR誤認識を含む見出しの80%以上が正しくマッチする

## Assumptions

- TOCマーカー（`<!-- toc -->` ... `<!-- /toc -->`）は既にbook.mdに追加されている
- TOCエントリは「N.N タイトル」または「N.N.N タイトル」形式である
- 本文見出しは `##` または `###` のMarkdownマーカーを持つか、マーカーなしのプレーンテキストである
- 見出しテキストの言語は主に日本語である
- 1つのbook.md内で見出し形式は概ね統一されている（複数形式が混在しても対応）

## Out of Scope

- 見出しテキスト自体のOCR誤認識修正（ファジーマッチングで対応するが、修正は手動）
- 4階層以上の見出し対応（Constitution準拠で最大3階層）
- book.md以外の入力形式（EPUB, PDF等）への対応
- リアルタイムでの見出し検出・正規化（バッチ処理のみ）
