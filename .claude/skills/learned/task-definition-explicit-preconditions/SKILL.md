---
name: task-definition-explicit-preconditions
description: "State data preconditions explicitly in task definitions and reference verification tasks to prevent implicit assumptions"
---

# Task Definition Explicit Preconditions

## Problem

Task definitions often contain **implicit assumptions** about data availability:

- Task says "process the data" but doesn't state what data must exist
- Assumption is unstated: "field X will be present"
- No verification step referenced
- Implementation proceeds on false assumptions
- Failure occurs when assumption doesn't hold

**Example**: Task T017 said "layout.jsonのTEXT領域を走査" but didn't state that `ocr_text` field must exist. Implementation assumed it would be there → Complete failure.

## Solution

### Make Preconditions Explicit

**Original (Implicit Assumptions)**:
```markdown
- [ ] T017 detect_code_regions() を実装
  - layout.jsonのTEXT領域を走査
  - Guesslangでコード判定
  - CODE属性を付与
```

**Implicit assumption**: `ocr_text` field exists in layout.json
**Problem**: If assumption is false, entire implementation fails

**Improved (Explicit Preconditions)**:
```markdown
- [ ] T017 detect_code_regions() を実装
  - **前提条件**: layout.json に `ocr_text` フィールドが存在すること
  - **検証方法**: T001a で確認済みであること
  - **検証結果**: [T001aの結果を参照]
  - layout.jsonのTEXT領域を走査
  - Guesslangでコード判定
  - CODE属性を付与
```

**Benefits**:
- ✅ Precondition is explicit and visible
- ✅ Links to verification task (T001a)
- ✅ Implementation blocked if verification fails
- ✅ False assumptions caught before coding

### Precondition Template

```markdown
- [ ] T### {Task Name}
  - **前提条件**: {What data/state must exist}
  - **検証方法**: {Which task verified this precondition}
  - **検証結果**: {Pass/Fail with details}
  - {Implementation details...}
```

### Verification Task Linkage

```markdown
# Setup Phase
- [ ] T001 既存実装の確認
- [ ] T001a **実データのスキーマ検証**
  - layout.json の実際の出力を確認
  - 結果: bbox, type, label のみ。ocr_text は存在しない ← 記録

# Implementation Phase
- [ ] T017 detect_code_regions() を実装
  - **前提条件**: layout.json に `ocr_text` フィールドが存在
  - **検証結果**: T001a により **存在しないことを確認** ← 矛盾！
  - **アクション**: 設計を修正（rover/*.txt を使用）
```

**Workflow**:
1. Setup Phase (T001a) verifies schema
2. Implementation task (T017) states precondition
3. Check verification result from T001a
4. If precondition not met → Stop and adjust design

## Example

### Before (Implicit, Fails)

```markdown
# tasks.md
- [X] T001 既存のレイアウト検出実装を確認
  - yomitoku の関数を列挙
  - layout.json のフォーマットを文書化

- [ ] T017 detect_code_regions() を実装
  - layout.jsonのTEXT領域を走査
  - Guesslangでコード判定
```

**Implementation**:
```python
def detect_code_regions(layout):
    for region in layout["regions"]:
        if region["type"] == "TEXT":
            text = region["ocr_text"]  # KeyError!
```

**Result**: Runtime failure, complete reimplementation needed

### After (Explicit, Caught Early)

```markdown
# tasks.md
- [X] T001 既存のレイアウト検出実装を確認
  - yomitoku の関数を列挙
  - layout.json のフォーマットを文書化

- [X] T001a **実データのスキーマ検証**
  - 実際の layout.json 出力を確認
  - **結果**: フィールド = bbox, type, label のみ
  - **結果**: ocr_text フィールドは **存在しない**

- [ ] T017 detect_code_regions() を実装
  - **前提条件**: layout.json に `ocr_text` フィールドが存在
  - **検証結果**: T001a により **不存在を確認** ← ⚠️ 矛盾
  - **アクション**: 設計を修正
    - 案A: OCRステップ後に実行
    - 案B: rover/*.txt から読み込み
```

**Result**: Design corrected before implementation, zero wasted effort

## When to Use

**Trigger this pattern when:**

1. Writing **implementation tasks** that depend on external data
2. Tasks consuming output from **other pipeline stages**
3. Tasks using **file formats** or **API responses**
4. Tasks with assumptions about **data structure**

**Red Flags:**

- ⚠️ Task says "process the data" without stating what data
- ⚠️ No "前提条件" section in task definition
- ⚠️ No reference to verification task
- ⚠️ "I assume field X exists..."

**Precondition Categories:**

1. **Data Schema**: "Field X must exist in file Y"
2. **File Existence**: "File X must be generated by step Y"
3. **Data Format**: "File must be valid JSON/XML/etc"
4. **Data State**: "Database must contain records from migration X"
5. **System State**: "Service X must be running"

## Checklist

For each implementation task, verify:

- [ ] Are there **data dependencies**?
- [ ] Is there a **前提条件** section?
- [ ] Does it reference a **verification task** (e.g., T001a)?
- [ ] Is the **verification result** recorded?
- [ ] If precondition fails, is there an **adjustment plan**?

## Template

```markdown
## Implementation Task Template

- [ ] T### {Task Name}
  - **前提条件**:
    - [ ] {Data/state requirement 1}
    - [ ] {Data/state requirement 2}
  - **検証方法**:
    - Verified in: {Task ID (e.g., T001a)}
    - Result: {Pass/Fail with details}
  - **検証失敗時のアクション**:
    - {Fallback plan if precondition not met}
  - **実装内容**:
    - {Step 1}
    - {Step 2}
```

## Impact

**Without Explicit Preconditions**:
- Assumption: ocr_text exists
- Implementation: 4+ hours wasted
- Testing: 55 tests pass (with mocks)
- Reality: Complete failure

**With Explicit Preconditions**:
- Verification: T001a checks schema (15 min)
- Discovery: ocr_text doesn't exist
- Action: Adjust design before coding
- Implementation: Correct from start
- Time saved: 4+ hours
